# 跨站请求伪造：利用与预防
## 摘要
跨站请求伪造（CSRF）在进行攻击时，恶意网站通过一些技术手段欺骗让用户的Web浏览器执行信任站点上的一些操作（如发邮件，发消息，甚至财产操作如转账和购买商品）。这类攻击方式被称为基于Web安全漏洞的“沉睡巨人”，由于在Web开发和安全社区中往往会被忽视掉，这就导致互联网中的许多网站因此失去了保护。在此我们提出在四个不同站点上四个严重的CSRF漏洞，其中包括有被我们认为是第一次涉及到金融机构的攻击。这些漏洞的存在，让攻击者从用户银行账户转移资金，获取用户电子邮件地址，侵犯用户隐私，危害用户帐户变成了可能。通过服务器端的一些更改，我们能够保护站点免受CSRF攻击（已经实现）。除此之外，我们还实现了一个客户端的浏览器插件，即使一个站点并没有对CSRF攻击进行防护用户也能够免受某种类型的CSRF攻击。我们希望通过这样的方式提升负责Web开发的程序员对CSRF攻击的防范意识，从而使用户免受这些攻击的伤害。

## 1.介绍
跨站请求伪造（CSRF）在进行攻击时，恶意网站通过一些技术手段欺骗让用户的Web浏览器执行信任站点上的一些操作（如发邮件，发消息，甚至财产操作如转账和购买商品）。这类攻击方式被称为基于Web安全漏洞的“沉睡巨人”，由于在Web开发和安全社区中往往会被忽视掉，这就导致互联网中的许多网站因此失去了保护。CSRF攻击一般不出现在Web安全威胁分类中同时也很少出现在学术和技术文献的讨论中。CSRF攻击通过简单的开发和修复，很容易能被诊断查明。它存在的原因是由于Web开发者对于CSRF攻击缺少相应的知识，对于CSRF攻击所能造成的原理和破坏性缺乏明确的认识，同时也许也是因为Web开发者误以为若能够防御著名的跨站脚本攻击（XSS）同时也就能防御CSRF攻击。

在第三节，我们将展示从四个重要主站上查找出的四个严重CSRF漏洞。攻击者利用这些漏洞可以完成从用户银行账户转移资金，获取用户电子邮件地址，侵犯用户隐私，危害用户帐户等行为。

在4.1节中，为了保护网站免受CSRF攻击我们建议对于服务器端进行更新变化。这个建议相较之前所提出的建议来说更加有效、更加优质，因为这样不需要客户端也不会破坏Web正常的访问，此外，我们实现了一个用于保护某种类型额的CSRF攻击（4.2节）的客户端浏览器插件。服务器端能够实现站点的完全保护,同时客户端同时也提供服务允许用户在网站没有采取相应的措施时保护自己，通过采取一定的措施来保护自己以免受各种类型的CSRF攻击。我们希望借此能够警醒Web开发者开发攻击来保护用户免受CSRF攻击的重要性。
## 2.CSRF的概述
图1、图2和图3表示的是CSRF的一般攻击流程

下面将详细描述使用CSRF攻击的攻击实例。
### 2.1 一个实例
先假设一个易受CSRF攻击的示例网站，该站点是一个基于Web的电子邮件网站，该网站允许用户发送和接收电子邮件。该站点使用隐式身份验证（参见第2.2节）对用户进行用户身份认证。一个页面包含一个HTML表单，允许用户输入收件人的电子邮件地址、主题、消息以及一个写着“发送邮件”的按钮, http://example.com/compose.htm。

```
<form
action="http://example.com/send_email.htm"
method="GET">
Recipient’s Email address: <input
type="text" name="to">
Subject: <input type="text" name="subject">
Message: <textarea name="msg"></textarea>
<input type="submit" value="Send Email">
</form>
```
当example.com的使用者点击“发送邮件”时，它输入的数据将作为一个GET请求发送到http://example.com/send_email.htm。由于GET请求只是简单地将表单数据附加到URL上，该使用者将会发送如下URL(假设“bob@example.com”为收件人，“你好”为主题，“现在有什么建议？”作为信息)：

```
http://example.com/send_email.htm?to=bob% 40example.com&subject=hello&msg=What%27s+the+ status+of+that+proposal%3F 
```

发送email.htm的页面只是通过接受到的数据从用户向收件人发送邮件，值得注意的是email.htm所做的只是获取数据并根据这些数据进行一些操作。该页面不关心请求是如何发出的，它只关心请求是否被发出。这也就是说，如果用户手动将上述URL手动输入到浏览器中，example.com仍然会发送电子邮件。例如，如果用户输入下列URL到浏览器中，email.htm将会发出三封邮件（将分别发送给Bob, Alice, 还有Carol）：

```
http://example.com/send_email.htm?to=bob%40example.com&subject=hi+Bob&msg=test
http://example.com/send_email.htm?to=alice%40example.com&subject=hi+Alice&msg=test
http://example.com/send_email.htm?to=carol%40example.com&subject=hi+Carol&msg=test
```
由于email.htm接收所有数据并且根据这些数据发送电子邮件,并且对于来自compose.htm 上的表单信息并不进行验证，因此CSRF攻击在此网站是可行的。由此攻击者可以让用户向email.htm发送一个请求，该网页能够让example.com

以用户身份发送包含任何攻击者所想要包含的数据，这样攻击者就成功完成了CSRF攻击。

通过利用这个漏洞，攻击者需要强制用户的浏览器向email.com发送一个请求来执行一些邪恶的行为。（我们假设用户访问一个在攻击者控制下的站点且目标站点并不抵御CSRF攻击。）具体来说，攻击者需要通过他自己的站点向example.com伪造一个跨站请求。不幸的是，HTML提供了许多方法来勾在这样的请求。例如  < img > 标签，它会使浏览器加载所有的URL并将这些URL设置为src属性，即使这个URL并不是一个图片的URL(由于浏览器之后加载了URL之后才能知道这是否是一个图像)，攻击者可以通过如下代码创建一个网页：

```
<img src="http://example.com/send_email.htm?to=mallory%40example.com&subject=Hi&msg=My+
email+address+has+been+stolen">
```
当用户访问这个网页的时候，将会有一个请求发送到email.htm，然后会向Mallory发送一封来自用户的邮件。这与我们在3.1节所举的在纽约时报网站上发现的漏洞几乎相同。

当攻击者成功让用户的浏览器在另一个站点执行一个非主动的操作，这就证明CSRF成功了。如果要使该操作能够成功，那么该操作应该是正常用户能够完成的操作。CSRF攻击所能进行的操作通常与一般用户相同，也就是说通过CSRF攻击攻击者能够执行任何一个用户都能执行的操作。也就是说，网站给用户越多权利，CSRF攻击能造成越大的威胁。

CSRF能够成功对几乎任何使用隐式认证（见2.2节）但未对采取具体措施保护自己免受CSRF攻击的网站进行攻击。

同源策略（见附录B）旨在防止攻击者访问第三方站点上的数据，但是该策略并不组织发送请求，它仅仅是防止攻击者读取从第三方返回的数据。因为CSRF攻击是请求发送的结果，因此同源策略并不能够防止CSRF攻击。


![](picture/1.jpg)

图2：有效请求。Web浏览器试图执行受信任操作。受信任站点确认Web浏览器已被认证，并且被运行执行该操作。

![](picture/2.jpg)

图3：CSRF攻击。被攻击站点让浏览器向可信站点发送请求。来自Web浏览器的认证请求并执行受信任操作，可信站点看似有效。由于网站验证的是Web浏览器而非用户，因此CSRF攻击有了进行的可能。

### 2.2 认证和CSRF
CSRF攻击通常会利用目标站点的认证机制来完成攻击。问题的根源在于Web身份验证通常能保证一个请求来自用户的浏览器，但它不能确保是否是用户实际请求或授权请求。

例如，假设Alice访问了目标站点T，站点T将向Alice的浏览器提供一个包含伪随机会话标识符SID的Cookie用来跟踪Alice的会话。Alice可能会被站点要求输入自己有效的用户名和密码进行登录，该站点会将Alice已登录记录在包含SID的Session 中。当Alice向站点T发出请求的时候，她的浏览器将自动向站点T发送包含SID的Cookie，用于标识这是来自Alice的会话。

现在假设Alice访问了恶意站点M，该站点包含有能使Alice的浏览器向站点T发送HTTP请求的JavaScript代码或图像标签，Alice的浏览器将会非常乐意地将包含SID的Session附加到该请求上。通过查验该请求，站点T通过Cookie的存在猜测该请求来自Alice，因此T站点将在Alice的帐号下执行该请求的操作。这就是一个成功的CSRF攻击。

其他大多数的Web身份认证机制都存在相似的问题。例如，HTTP BasicAuth机制会要求Alice用户名和密码告知她的浏览器，然后浏览器将会非常乐意地将Alice的用户名和密码附加到将发送给站点T的请求当中。除此之外，站点T可能用到了客户端的SSL证书，但仍然会出现相同的问题——浏览器将会非常乐意地将证书附加到将发送给站点T的请求当中。于之前相同，站点T通过IP地址证明用户是Alice，因此CSRF攻击变成了可能。

一般来说，只要一个站点无条件接收来自可信浏览器的认证请求，那么该站点都存在着被CSRF攻击的危险。从理论上来说，只要要求在向站点发送请求的时候，让用户执行一个确定的、无法被伪造的行为（如重新输入用户名和密码），这种危险就会被击溃；但是在实际运用中，这主要会影响站点的可用性。广泛采用的标准和认证机制都无法避免CSRF攻击，因此我们需要寻找一个可能的解决方案来解决这个问题。

### 2.3 CSRF攻击向量
如果想要成功进行CSRF攻击，用户必须登陆到目标站点并且需要同时访问到攻击者的站点或者是攻击者部分控制的站点。

如果一个服务器含有CSRF漏洞同时也接收GET请求（如上一例）CSRF攻击可以不使用JavaScript（例如，一个简单的< IMG >标签可以被用来进行CSRF攻击）。如果服务器只接收POST请求，则需要JavaScript从攻击者站点自动向目标站点发送POST请求。

### 2.4 CSRF vs XSS

