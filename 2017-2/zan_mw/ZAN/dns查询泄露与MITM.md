# DNS查询泄漏（经由DNS解析服务器）与MITM #
## DNS查询泄漏的概念 ##
### 什么是DNS泄露 ###
当使用匿名或隐私服务时，计算机的所有流量需要通过匿名网络进行路由。如果流量泄漏，网络连接不安全，任何监控流量的黑客都能够记录用户网络的活动。

DNS（域名解析服务器）用于把域名解析为IP地址，然后使用这个IP地址路由数据包。大多数互联网服务提供商为他们的客户分配一个DNS服务器，它们用于记录用户的互联网活动。

在某些情况下，即使连接到匿名网络，操作系统将继续使用其默认DNS服务器，而不是匿名网络分配给您的计算机的匿名DNS服务器。 DNS泄漏是一个主要的隐私威胁，因为匿名网络可能会在私人数据泄露的同时提供错误的安全感。
![](pic/what-is-a-dns-leak.png)

----------

### DNS透明代理（Transparent DNS Proxies） ###
一些ISP正在使用一种“透明DNS代理”的技术。使用这种技术，它们将拦截所有DNS查询请求（TCP/UDP端口53），并透明地代理结果。这会导致被迫其DNS服务进行所有DNS查找。


如果你修改了你的DNS设置使用一个诸如Google, Comodo或OpenDNS之类的'开放'DNS服务，你以为你的DNS流量不再被发送到你的互联网接入服务提供商的DNS服务器，你或许会震惊于发现了他们正在使用透明DNS代理。

> 所谓透明代理，就是说虽然你的DNS客户端没有设置使用该代理服务器，但该代理服务器会不以你意志转移的强行代理你的DNS请求。

如果ISP使用的是透明的DNS代理，为了确保连接到VPN时，网络请求没有被拦截，需要参考 https://www.dnsleaktest.com/how-to-fix-a-dns-leak.html 上的方法。

![](pic/transparent-dns-proxy.png)

## MITM ##
从被怀疑是中间人攻击的链接中捕捉网络数据包并进行分析可以确定是否存在中间人攻击。在进行网络分析并对可疑的SSL中间人攻击进行取证时，重要的分析证据包括：

- 远程服务器的IP地址
- DNS域名解析服务器
- X.509证书服务器
- 证书是自签名证书吗？
- 证书是由信任的颁发机构颁发的吗？
- 证书是否已被吊销？
- 证书最近被更改过吗？
- 在互联网上的其他的客户端是否也得到了相同的证书？
## 参考资料 ##
- https://www.dnsleaktest.com
- https://en.wikipedia.org/wiki/Man-in-the-middle_attack