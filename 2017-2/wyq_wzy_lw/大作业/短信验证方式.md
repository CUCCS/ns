# 短信验证方式
#### 原理简介
短信验证码是通过发送验证码到手机的一种有效的验证码系统。无论是大型网站尤其是购物网站，都提供有手机短信验证码功能，可以比较准确和安全地保证购物的安全性，验证用户的正确性。某些验证码接入商提供手机短信验证码服务，各网站通过接口发送请求到接入商的服务器，服务器发送随机数字或字母到手机中，由接入商的服务器统一做验证码的验证。

短信验证码常见于注册，忘记密码，确认下单等阶段，特别是一些涉及到用户个人敏感行为时候，为了确认操作是用户本人执行的通常会使用短信验证码进行二次认证。同时，短信验证码也是最为常见的验证码类型之一
#### 需求分析
因为验证码是一个混合了数字或符号的图片，人眼识别较不容易，机器识别就会更困难。所以验证码一般是防止有人利用机器人自动批量注册、对特定的注册用户用特定程序（暴力破解）方式进行不断的登陆、灌水。防止刷单行为，保证一机一码，保证企业的利益不受损害。
#### 识别流程
触发短信认证——>发送验证码——>返回识别结果——>填入完成验证
#### 使用说明
在系统中录入注册会员手机号码之前，提醒注册会员：录入的手机号码一定是注册会员本人的，而且该手机此刻携带在注册会员身边，若没带手机，需请注册会员带上手机再来申请。注册的会员手机会收到一个随机的验证码短信，内容大多为：“尊敬的顾客，某某公司提供的某某服务为了保证您的隐私，验证码为：******，在半小时内使用。”会员使用该验证码来通过注册或者验证身份。如果注册会员在半小时内未收到验证短信或者未将验证码验证，那该验证码将会失效，可再次点击"发送验证码"按钮，系统将会发送第二个验证码到注册会员手机上，需要将第二个验证码重新输入”验证码“栏中。
#### 原理简介
1. 手机短信验证码是OTP【one time password】的一种实现方式：挑战/应答方式；
2. 挑战应答方式：挑战：后台下发一条随机码X。应答：网页客户端通过算法（例如MD5）将用户信息和随机码X合并，经处理后生成一条字符串Y，并返回给后台；
3. 后台用同样的算法处理这条随机码X和后台存储的用户信息，得到一条字符串Z。后台比对来自客户端的字符串Y和自己生成的字符串Z，如果两者一致，则确认用户身份或交易结果。
#### 接口实现
短信接口一般支持http和webservice调用。程序员在需要发送短信的地方添加接口地址和相关参数，如接收端手机号码、接收的内容以及其他接口参数，调用完就会返回xml数据，表示成功提交或者失败。关于回复短信，会绑定到一个接收回复内容的地址，有短信回复过来就推送到对应地址。
#### 使用范围
短信验证码是目前使用最广泛的一种验证方式，目前使用的最普遍的有各大银行，网上银行，网上商城、团购网站、票务公司等，他们利用短信验证码来注册会员，大大降低了非法注册，烂注册的数据。
#### 逻辑漏洞总结
* **接口没设频次上限导致短信轰炸**

起因：短信轰炸问题往往出现在一些小站或者子站，目前基本都是使用POST请求发送短信验证码，使用抓包软件可以重放请求对于后端没有做限制的网站就可以达到短信轰炸的效果。

危害：对用户来说个人生活受到骚扰，对企业来说造成一定的负面影响，很多小公司因为短信接口被大量调用出现运营问题，对于公司没有安全工程师的情况下，一般都是业务方发现数据异常向上汇报，最后和开发人员一起反溯才会找到问题，而在这段时间中企业所损失的资金也是无法挽回的。

预防：这里主要是针对两种攻击场景来进行防御。（第一种是对单用户的短信轰炸，即重放发送请求且phonenum为一个值。第二种是对多用户发送短信骚扰的场景，即将phonenum参数设置为字典，重放短信接口。）
1. 设置发送间隔。即单一用户发送请求后，与下次发送请求时间需要间隔60秒。
2. 设置单用户发送上限，即设置每个用户单位时间内发送短信数的上限，如果超过阈值就不允许今天再次调用短信接口(阈值根据业务情况设置)。
3. 设置单IP发送上限。（针对第二种攻击场景），由于IP的特殊性可能存在所处IP是大出口，一旦误杀后果会很严重，所以这个限制根据自身情况酌情考虑，对于有风控的团队来说，当发现发送IP存在异常可以对该IP增加二次认证来防止机器操作，也可以降低误杀情况。
* **验证码内容包含在返回包中**

起因：因为开发不严谨导致通过抓包可以看到验证码在回显中显示。

危害：由于验证码直接返回，通过该漏洞可以注册任意用户，重置已注册用户密码，修改绑定信息等高危操作，对用户造成一定影响。

预防：不要将短信验证码在回显中显示，验证码只存于服务端中并不能通过任何api直接获取。

* **修改返回包内容绕过验证**

起因：前段校验不严格

危害：可跳过正常校验逻辑

预防：服务端严格做检验，配合开发人员减少逻辑漏洞