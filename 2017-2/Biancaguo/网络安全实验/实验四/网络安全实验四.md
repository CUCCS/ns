# 计算机入侵取证

----------

## 原始数据：

包含可疑流量的pcap数据包（attack-trace.pcap）

## 实验环境：

![](https://i.imgur.com/fvQccUU.jpg)

## 实验目标：

通过分析数据样本包，获取包含的TCP并发会话数量、攻击者和靶机的IP地址、靶机在此次安全事件中被利用的漏洞等信息。


## 方法一：基于bro分析

### 一、什么是bro？

> Bro is a powerful network analysis framework（网络入侵检测系统）. While focusing on network security monitoring（安全监控）, Bro provides a comprehensive platform for more general network traffic analysis as well（流量分析）.  Today, it is relied upon operationally in particular by many scientific environments for securing their cyberinfrastructure. 

### 二、实验步骤

#### 1、配置bro

* 操作：编辑/etc/bro/site/local.bro文件，尾部追加
 
	    @load frameworks/files/extract-all-files
		@load mytuning.bro

* 说明：加载库指令，以@load来加载module中定义的命名空间。命令1表示使用bro提取所有文件，命令2表示加载mytuning.bro中我们自己编写的指令

![](https://i.imgur.com/lWPh3Of.jpg)

* 操作：在/etc/bro/site/目录下mytuning.bro，写入代码：

		redef ignore_checksums = T;

* 说明：使bro能够在系统上分析本地捕获流量，忽略校验和验证。

![](https://i.imgur.com/mFbelCg.jpg)

#### 2、使用bro分析流量包

* 操作：命令行中输入 `bro -r attack-trace.pcap /etc/bro/site/local.bro`

* 说明： 

		-r：表示分析的为数据包
		attack-trace.pcap：待分析数据包
		/etc/bro/site/local.bro：

	* 注意：直接运行将会弹出警告信息，不影响分析结果，可在mytuning.bro中写入`redef Site::local_nets = { 本地网络IP地址范围（因本数据包中假定靶机IP为192.150.11.1，故将此处填写为192.150.11.0/24 };`消除。添加后会新增2个日志文件，报告待分析数据包中发现的本地网络IP和该IP关联的已知服务信息

![](https://i.imgur.com/ViFqIDA.jpg)

![](https://i.imgur.com/csepxAb.jpg)

#### 3、在线分析extract_files目录下的文件，确定攻击类型

![](https://i.imgur.com/eZPIzfx.jpg)

![](https://i.imgur.com/4kOk2Lj.jpg)


* 经过在线分析表明这是一个已知蠕虫病毒，接下来将寻找入侵线索。


#### 4、阅读源代码分析入侵线索

* 操作：阅读/usr/share/bro/base/files/extract/main.bro

* 说明：通过阅读main.bro，可知文件名最后的id是file.log中文件唯一标识符

![](https://i.imgur.com/iypiNiY.jpg)

![](https://i.imgur.com/63OWyCR.jpg)

* 操作：阅读file.log

* 说明：获得对应conn_uids

![](https://i.imgur.com/DawtLcK.jpg)

* 操作：阅读conn.log

* 说明：获得攻击者ip地址

![](https://i.imgur.com/jiRPWz3.jpg)


#### 5、log文件查看技巧

	查看conn.log中所有可用的“列名”：grep ^#fields conn.log | tr '\t' '\n'
	按照“列名”输出conn.log中我们关注的一些“列”：bro-cut ts id.orig_h id.orig_p id.resp_h id_resp_p proto < conn.log
	将UNIX时间戳格式转换成人类可读的时间：bro-cut -d < conn.log



## 方法二：tshark与snort配合使用

### 一、什么是snort？

> 一个强大的网络入侵检测系统。它具有实时数据流量分析和记录IP网络数据包的能力，能够进行协议分析，对网络数据包内容进行搜索/匹配。它能够检测各种不同的攻击方式，对攻击进行实时报警。此外，Snort是开源的入侵检测系统，并具有很好的扩展性和可移植性。

### 二、实验步骤

#### 1、统计数据包内流量信息

* 操作：使用`tshark -r attack-trace.pcap -z ip_hosts,tree -qn`或wireshark端点统计工具
* 说明：统计数据包内信息
	
	-r：后跟待分析流量包

	-z: 设置统计参数

![](https://i.imgur.com/CciIpYj.jpg)

![](https://i.imgur.com/Jf7XVqz.jpg)

#### 2、发现攻击者ip

* 操作：使用命令 `tshark -r attack-trace.pcap -Y "tcp.flags==0x02" -n`

* 说明：筛选建立tcp连接的数据包

![](https://i.imgur.com/27elUUy.jpg)

#### 3、查看攻击持续时间

* 操作：capinfos attack-trace.pcap

* 说明：计算捕获到数据包的起始时间

![](https://i.imgur.com/8tPiTgl.jpg)

#### 4、利用snort进行行为分析

* 操作：修改/etc/snort/snort.conf，将var HOME_NET后修改为[192.150.11.0/24]（本实验中靶机地址假定为192.150.11.1）；执行`sudo snort -q -A console -c /etc/snort/snort.conf -r attack-trace.pcap `

* 说明：
	   -q：不显示状态报告
	   -A：信息输出到控制台
	   -c：指定使用的配置文件
       -r：待分析数据包

![](https://i.imgur.com/uYTISwy.jpg)

#### 5、统计会话进行攻击过程划分

* 操作：执行`tshark -r attack-trace.pcap -qnz conv,tcp` 

* 说明：以表格形式统计tcp会话

![](https://i.imgur.com/DnmomOH.jpg)

猜测：扫描/枚举、漏洞利用、执⾏攻击指令、FTP会话、下载恶意代码

#### 5、利用wireshark追踪tcp流，线上分析tcp报文

* 操作：打开wireshark，点击统计——>对话——>TCP，选中一条tcp会话应用为过滤器，而后跟踪tcp流，获取完整报文信息。将报文信息存储到文件中，进行线上分析

![](https://i.imgur.com/IMYStXx.jpg) 

![](https://i.imgur.com/AU57oqN.jpg)

![](https://i.imgur.com/Nky0lch.jpg)

### 参考材料

教材、课件

http://www.freebuf.com/articles/system/135843.html

https://www.jianshu.com/p/113345bbf2f7
