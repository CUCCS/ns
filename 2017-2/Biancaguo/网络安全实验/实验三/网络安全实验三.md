## From SQL Injection To Shell 实验报告&学习手册

### 零、前期准备

#### 1、两台虚拟机网络均设置为桥接模式

#### 2、获得两个系统的ip地址：ifconfig

(1)ifconfig查看攻击者本机IP地址

![](https://i.imgur.com/Cutix4H.png)

(2)netdiscover扫描靶机ip地址

![](https://i.imgur.com/2cPxIvC.png)


#### 3、在攻击者hosts文件中添加靶机ip-hostname对应关系

![](https://i.imgur.com/OtTCFQS.png)


### 一、收集指纹

*目标：从网页应用和使用的工具上收集信息*

#### 1、使用浏览器查看

![](https://i.imgur.com/Bz0S1AK.png)

![](https://i.imgur.com/02oWEzk.png)

* 发现为php编写的应用程序

#### 2、检查http响应头

（1）学会使用netcat或telnet访问靶机80端口，发送http请求，查看http response的信息

![](https://i.imgur.com/FfGoZDA.png)

* 连接443端口被拒绝，说明未开启HTTPS服务，仅能通过HTTP协议访问

![](https://i.imgur.com/UN6e9mv.png)

* 若开启了https服务，netcat和telnet连接均会失效，此时可使用`openssl s_client -connect vulnerable:443`

（2）学会使用Burp Suite查看http response的信息

![](https://i.imgur.com/TrzsqAN.png)

#### 3、使用目录扫描工具-wfuzz（kali内置多个字典文件用于破解）

（1）检测远程服务器上的文件和文件夹 

	命令： python wfuzz.py -c -z file,wordlist/general/big.txt --hc 404 http://vulnerable/FUZZ

	参数： -c 高亮显示
          --hc 400 忽略404响应
          -z file -f wordlists/big.txt 使用字典（wordlists/big.txt）破解远程目录名
          http://vulnerable/FUZZ  使用查找到的目录名替换FUZZ位置
         
![](https://i.imgur.com/ldcuf8H.png)

（2）检测远程服务器上的PHP脚本 

	命令： python wfuzz.py -c -z file,wordlist/general/big.txt --hc 404 http://vulnerable/FUZZ.php

![](https://i.imgur.com/xIn4zZg.png)

### 二、SQL注入的检测与应用

*目标：掌握什么是SQL注入以及如何通过SQL注入获得信息*

#### 1、检测SQL注入

（1）SQL简介

* SQL：Standard Query Language
* **SELECT:检索**
* UPDATE：修改
* INSERT：增加
* DELETE：删除

（2）基于数字的检索

	url：http://vulnerable/cat.php?id=1
	php：
		<?php
			$id = $_GET["id"];
			$result= mysql_query("SELECT * FROM articles WHERE id=".$id);
			$row = mysql_fetch_assoc($result);
			// ... display of an article from the query result ...
		?>
	sql：SELECT * FROM tablename WHERE id=1

* 简单利用示例

![](https://i.imgur.com/7vTk2bn.png)

![](https://i.imgur.com/D1glJNT.png)

（2）基于字符串的检索

* 引号闭合则不会报错
* 使用`' --`闭合sql语句并省略--后的语句：`SELECT id,name FROM users where name='test' -- ' and id=3;`

![](https://i.imgur.com/sonbFfw.png)

![](https://i.imgur.com/8ldaI62.png)

#### 2、利用SQL注入

（1）UNION关键字

* 连接两个请求
* union前后两条select语句应返回相同数目的键对应的值

（2）利用UNION实现SQL注入

* 关键：猜列数

方法一：

![](https://i.imgur.com/PMYsuCQ.png)

方法二：

![](https://i.imgur.com/JzkDzeE.png)

* 示例

![](https://i.imgur.com/uFzZbd6.png)

* 应用

获取php版本号：

![](https://i.imgur.com/clkZrcD.png)

获取系统当前用户名：

![](https://i.imgur.com/slltoNQ.png)

获取当前连接的数据库名：

![](https://i.imgur.com/Ubh6CbK.png)

（3）通过查看information_scheme数据库获取更多信息

* information_scheme：在MySQL中，把 information_schema 看作是一个数据库，确切说是信息数据库。其中保存着关于MySQL服务器所维护的所有其他数据库的信息。如数据库名，数据库的表，表栏的数据类型与访问权限等。

* 应用

查看数据库中所有表名：

![](https://i.imgur.com/uFRW2So.png)

查看数据库中所有列名：

![](https://i.imgur.com/y0fqrHs.png)

查看表名和列名的对应关系：

![](https://i.imgur.com/9Jy0mJa.png)

获取管理员密码：

![](https://i.imgur.com/6dIhvuQ.png)

### 三、实战：获取管理员权限并进行代码注入

#### 1、破解密码

* 方法一：使用搜索引擎
* 方法二：John the ripper密码破解工具。

![](https://i.imgur.com/YYKM4n4.png)

（1）john支持的加密方式：

![](https://i.imgur.com/2bjyFyY.png)

（2）使用john破解加密的管理员密钥

	命令：john password --format=raw-md5 --wordlist=dico --rules
	参数：password：包含待解密密码的文件
		 --format=raw-md5：密码加密方式
		 --wordlist=dico：使用的密码字典
		 --rules：尝试每个词的变体


![](https://i.imgur.com/RfxcpwC.png)

#### 2、利用wellshell进行代码注入

* 可注入php脚本

（1）进入管理员后台：

![](https://i.imgur.com/Vyucvfn.png)

（2）上传php脚本

![](https://i.imgur.com/MVjybUF.png)

（3）脚本利用（利用cmd执行任意命令）

* 获取靶机系统用户列表

![](https://i.imgur.com/q6f5O1W.png)

* 获取靶机内核版本信息

![](https://i.imgur.com/QN0q6Pz.png)

### 四、实验结论

本实验手动检测和利用SQL注入来获取对管理页的访问。

#### 1、SQL注入威胁表现形式可以体现为以下几点：

        ● 绕过认证，获得非法权限
        ● 猜解后台数据库全部的信息
        ● 注入可以借助数据库的存储过程进行提权等操作

#### 2、SQL注入攻击的典型手段

        ● 判断应用程序是否存在注入漏洞
        ● 收集信息、并判断数据库类型
        ● 根据注入参数类型，重构SQL语句的原貌
        ● 猜解表名、字段名
        ● 获取账户信息、攻击web或为下一步攻击做准备

### 五、参考材料

From SQL Injection To Shell指导书
