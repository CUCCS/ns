# TCP/IP协议与网络安全

## TCP/IP协议的总体概况

TCP/IP协议叫做传输控制/网际协议，是Internet国际互联网络的基础。TCP/IP是网络中使用的基本的通信协议。其中IP(InternetProtocol)全名为“网际互连协议”，是为计算机网络相互连接进行通信而设计的协议。TCP(TransferControlProtocol)是传输控制协议。TCP/IP协议是能够使连接到网上的所有计算机网络实现相互通信的1套规则，正是因为有了TCP/IP协议,因特网才得以迅速发展成为世界上最大的、开放的计算机通信网络。

## TCPIP协议主要工作流程

TCP/IP协议主要工作流程如下（以文件传输为例）：

1. 源主机应用层将相关数据流传送给传输层；
2. 传输层将数据流进行分组，并加上TCP包头传送给网络层；
3. 在网络层加上包括源、目的主机IP地址的IP报头，生成IP数据包，并将生成的IP数据包传送至链路层；
4. 在链路层将MAC帧的数据部分装入IP数据包，然后将源、目的主机的MAC地址和帧头加上，并根据目的主机的MAC地址，将完整的MAC帧发往目的主机或者IP路由器；
5. MAC帧到达目的主机后，在链路层将MAC帧的帧头去掉，并将去掉MAC帧头的IP数据包传送至网络层；
6. 网络层对IP报头进行检查，如果校验与计算结果不同，则将该IP数据包丢弃，如果结果一致就去掉IP报头，将TCP段传送至传输层；
7. 传输层对顺序号进行检查，判断是否是正确的TCP分组，然后再对TCP报头数据进行检查。如果正确就源主机发出确认信息，如果不正确或者是出现丢包，就想源主机发出重发要求；
8. 在目的主机的传输层将TCP报头去掉后根据顺序对分组进行组装，然后将组装好的数据流传送给应用程序

## TCP/IP协议的安全隐患

### 关于链路层存在的安全漏洞

在以太网中，信息通道是共享的，一般地，CSMACD协议是以太网接口在检测到数据帧不属于自己时，就把它忽略，不会把其发送到上层协议。解决该漏洞的对策是：网络分段、利用交换器、动态集线器等设备对数据流进行限制、加密和禁用杂错节点。

### 关于IP漏洞

IP包一旦从网络中发送出去，源IP地址就几乎不用仅在中间路由器因某种原因丢弃它或到达目标端后，才被使用。如果攻击者把自己的主机伪装成被目标主机信任的友好主机，即把发送的IP包中的源IP地址改成被信任的友好主机的IP地址，利用主机间的信任关系和这种信任关系的实际认证中存在的脆弱性，就可以对信任主机进行攻击。解决这个问题的一个办法是，让路由器拒绝接受来自网络外部的IP地址与本地某一主机的IP地址相同的IP包的进入。

### 关于DNS欺骗

网络上的所有主机都信任DNS服务器，如果DNS服务器中的数据被攻击者破坏，就可以进行DNS欺骗。

## SYNFLOOD攻击的基本原理

### 攻击原理

在SYNFlood攻击中，黑客机器向受害主机发送大量伪造源地址的TCPSYN报文，受害主机分配必要的资源，然后向源地址返回SYN＋ACK包，并等待源端返回ACK包。由于源地址是伪造的，所以源端永远都不会返回ACK报文，受害主机继续发送SYN＋ACK包，并将半连接放入端口的积压队列中，虽然一般的主机都有超时机制和默认的重传次数，但是由于端口的半连接队列的长度是有限的，如不断的向受害主机发送大量的TCPSYN报文，半连接队列就会很快填满，服务器拒绝新的连接，将导致该端口无法响应其他机器进行的连接请求，最终使受害主机的资源耗尽。

### 防御方法

SYN－cookie技术一般情况下，当服务器收到一个TCPSYN报文后，马上为该连接请求分配缓冲区，然后返回一个SYN＋ACK报文，这时形成一个半连接。SYNFlood正是利用了这一点，发送大量的伪造源地址的SYN连接请求，而不完成连接。这样就大量的消耗服务器的资源。

SYN－cookie技术针对标准TCP连接建立过程资源分配上的这一缺陷，改变了资源分配的策略。当服务器收到一个SYN报文后，不立即分配缓冲区，而是利用连接的信息生成一个cookie，并将这个cookie作为将要返回的SYN＋ACK报文的初始序列号。当客户端返回一个ACK报文时，根据包头信息计算cookie，与返回的确认序列号（初始的序列号＋1）的前24位进行对比，如果相同，则是一个正常连接，然后，分配资源，建立连接。

该技术的巧妙之点在于避免了在连接信息未完全到达前进行资源分配，使SYNFlood攻击的资源消耗失效。实现的关键之处在于cookie的计算。cookie的计算应该做到包含本次连接的状态信息，使攻击者不能伪造cookie。

