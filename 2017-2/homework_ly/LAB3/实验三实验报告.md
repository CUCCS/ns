# 从SQL注入到Shell

## 实验目的

> 在基于php的网站中进行SQL注入，利用它访问管理界面，在服务器上获得代码执行

## 实验要求

1. 指纹识别:收集有关使用的web应用程序和技术的信息

2. SQL注入的检测和开发:了解SQL注入是如何工作的，以及如何利用它们来检索信息

3. 访问管理页面和代码执行:访问操作系统和运行命令

##实验步骤

###安装SQL，配置IP

SQL服务器IP

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/sql%20ip%E5%9C%B0%E5%9D%80.png?raw=true)

攻击者主机IP

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/%E6%94%BB%E5%87%BB%E8%80%85%E4%B8%BB%E6%9C%BAip%E5%9C%B0%E5%9D%80.png?raw=true)

攻击者主机浏览器设置代理

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/%E6%B5%8F%E8%A7%88%E5%99%A8connection%20setting.png?raw=true)

攻击者主机与服务器可相互ping通

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/%E6%94%BB%E5%87%BB%E8%80%85%E4%B8%BB%E6%9C%BA%E4%B8%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8F%AF%E4%BB%A5%E7%9B%B8%E4%BA%92ping%E9%80%9A.png?raw=true)

### 指纹

使用burpsuite查看通信数据：http响应报头，可收集服务器的相关信息，如PHP版本

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/http%E8%AF%B7%E6%B1%82.png?raw=true)

## 检测并利用SQL注入

### 基于整数的检测

通过http://10.0.2.6/cat.php?id=3 与 http://10.0.2.6/cat.php?id=2+1 返回的页面相同，说明数据库直接进行了减法，而没有对这种输入过滤， 因此存在SQL注入的可能性 

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/%E6%95%B0%E5%AD%97%E6%A3%80%E6%B5%8B3.png?raw=true)

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/%E6%95%B0%E5%AD%97%E6%A3%80%E6%B5%8B2+1.png?raw=true)

### 基于字符串的检测

使用奇数个 ' 来测试，导致语法错误

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/%E5%AD%97%E7%AC%A6%E6%A3%80%E6%B5%8B.png?raw=true)

### 使用UNION进行SQL注入

利用UNION前后select语句返回的列值必须相同，由此可以递增查询列数，从而检测出数据库在查询该语句时会查多少列

当猜测列数与实际列数不同时，会返回错误信息

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/select%201.png?raw=true)

猜测正确时返回的信息

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/select1,2,3,4.png?raw=true)

也可以使用order by来获取列数

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/order%20by%205.png?raw=true)

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/order%20by%204.png?raw=true)

通过@@version获得数据库版本信息

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/%E7%89%88%E6%9C%AC.png?raw=true)

通过current_user()获得当前用户信息 

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7.png?raw=true)

通过database()获得数据库名

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/database.png?raw=true)

查询表与列的对应关系

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/%E8%A1%A8%E4%B8%8E%E5%88%97.png?raw=true)

查询user表中的login和password字段

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/%E7%94%A8%E6%88%B7%E5%90%8D%E5%8F%8A%E5%AF%86%E7%A0%81.png?raw=true)

将得到的密码哈希值在线解密，得到密码为P4ssw0rd，成功登陆管理员账户

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/%E5%9C%A8%E7%BA%BF%E8%A7%A3%E5%AF%86.png?raw=true)

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/%E7%99%BB%E5%BD%95%E6%88%90%E5%8A%9F.png?raw=true)

上传shell.php,返回错误信息"NO PHP"

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/%E7%BC%96%E5%86%99shell.png?raw=true)

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/NO%20PHP.png?raw=true)

将shell文件后缀名改为php3，可以绕过.php过滤。

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/%E6%94%B9%E5%90%8E%E7%BC%80.png?raw=true)

上传成功

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/%E4%B8%8A%E4%BC%A0%E6%88%90%E5%8A%9F.png?raw=true)

访问上传的php文件，并查看页面审查元素

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/%E6%9F%A5%E7%9C%8B%E9%A1%B5%E9%9D%A2%E5%85%83%E7%B4%A0.png?raw=true)

通过cmd参数获取大量页面信息

1. cmd=uname返回当前系统内核

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8.png?raw=true)

2. cmd=ls显示当前目录所含文件信息

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/%E5%BD%93%E5%89%8D%E7%9B%AE%E5%BD%95%E6%89%80%E5%90%AB%E6%96%87%E4%BB%B6.png?raw=true)

3. cmd=cat /etc /passwd显示用户列表

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF.png?raw=true)

4. cmd=cat /etc /passwd显示主机信息

![](https://github.com/LuYe2/ns/blob/master/2017-2/homework_ly/LAB3/%E4%B8%BB%E6%9C%BA%E4%BF%A1%E6%81%AF.png?raw=true)


